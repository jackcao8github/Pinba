<!DOCTYPE html>
<html manifest="../pinba.appcache">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
<link rel="stylesheet" href="../css/jquery.mobile-1.4.5.min.css" />
<script src="../js/jquery-1.11.3.min.js"></script>
<script src="../js/jquery.mobile-1.4.5.min.js"></script>

<style>
.msgStatus {
	background: #26c281;
	border-radius: 50%;
	width: 9px;
	height: 9px;
	position: absolute;
	top: 31px;
	right: 17px;
}

.msgStatus.active {
	background: #26c281;
}

.msgStatus.inactive {
	background: #eaeef0;
}
</style>

</head>
<body>
	<div data-role="page" id="messagePage">
		<div data-role="header" data-position="fixed" data-fullscreen="false"
			data-tap-toggle="false">
			<!-- 返回按钮 -->
			<h1>我的消息</h1>
			<a href="#" data-icon="plus" class="ui-btn-right" data-iconpos="notext" onclick="toAddFriend()">Options</a>
		</div>
		<!-- 加好友方式选择-->
		<div data-role="popup" id="popupMenu">
			<ul data-role="listview" data-inset="true" style="min-width: 210px;"
				id="typeList">
				<li data-role="list-divider">加好友</li>
				<li><a href="#" onclick="addFriendByCellphone()">使用手机号</a></li>
				<li><a href="#"  onclick="addFriendByNearby()">附近的人</a></li>
			</ul>
		</div>
		
		<div id="tabs" data-role="tabs">
			<div data-role="navbar">
				<ul>
					<li><a href="#messageList" class="ui-btn-active"
						id="messageTabLi">消息列表</a></li>
					<li><a href="#friendList">好友列表</a></li>
				</ul>
			</div>

			<div id="messageList">
			<div class="swipe">
				<div class="pullDownFresh">
					<div class="pullDownFreshText">下拉刷新</div>
				</div>
				<div class="pullNoData">没有数据!你可以下拉刷新!</div>
			
				<ul data-role="listview" id="messageListUL">
				</ul>
				</div>
			</div>
			<div id="friendList">
			<div class="swipe">
				<div class="pullDownFresh">
					<div class="pullDownFreshText">下拉刷新</div>
				</div>
				<div class="pullNoData">没有数据!你可以下拉刷新!</div>
				<ul data-role="listview" id="friendListUL">
					<!-- <li data-icon="false"><a href="#" onclick="changeSubPage('friendsMsg','messagePage','friendId=101')"
						data-ajax="false" style="padding-top: 0px; padding-bottom: 0px;">
							<img src="image/firstcover02.png">
							<h2>Hilton</h2> 名字
							<p>life is beaultiful.</p> 签名
							<div style="float: left;">
								性别
								<img style="height: 0.8em; width: 0.8em;"
									src="image/main_index_home_pressed.png"><span
									style="font-size: 0.8em">335</span> </img>
							</div>

							<div style="margin-left: 10px; float: right;">
								距离
								<img style="height: 0.8em; width: 0.8em;"
									src="image/my_favorite_user_icon_normal.png"><span
									style="font-size: 0.8em">3350米</span> </img>
							</div>
					</a></li> -->
				</ul>
				</div>
			</div>
		</div>

	</div>
</body>


<script type="text/javascript" src="../myjs/myswipe.js"></script>
<script type="text/javascript" src="../myjs/mycommon.js"></script>
<script type="text/javascript">
/* function swipeLeft(){
	//打开当前页面左边页面
	parent.switchIframeByClick('wode');
}

function swipeRight(){
	//打开当前页面右边页面
	parent.switchIframeByClick('fabu');
} */

    $(document).ready(function(){
    	//绑定控件滑动事件
		bindSwipeEvent();
		getLoginUserInfo();
    	loadMsgList();
    	loadFriendList();
    });
    
   /*  function pageInit(){
    	loadMsgList();
    	loadFriendList();
    } */
    
    function swipeDown(){
    	$('#friendListUL').html('');//清除已有li
    	$('#friendListUL').html('');
    	loadMsgList();
    	loadFriendList();
    }

	/* 加载20条消息，按照消息来源用户及消息类型进行汇总，按照时间倒序排列 */
	function loadMsgList() {
		var cachedUserInfo = str2Json(localStorage.userInfo);
		if (cachedUserInfo != null) {
			var userInfo = {};
			userInfo.userId = cachedUserInfo.userId;
			ajaxReq('userAction', {
				method : 'getAllTypeNewMsg',
				userInfo : json2Str(userInfo)
			}, function(data) {
				if (data.length>0) {
					fillMessageList(data);
				} else {
					$('#messageList .pullNoData').show();
				}
			});
		}
	}
	function fillMessageList(arr){
		$('#messageListUL').html('');//清除已有li

		var ulHtml = '';
		var liTemplate = '<li data-icon="false"><a href="#" onclick="toMsgPage(this,\'-friendId-\',\'-friendName-\',\'-msgType-\',\'-headPicImageId-\')"> \
			<h3>-msgTypeName-</h3> \
			<p>-friendName-</p> \
				<p>-msgContent-</p> \
				<p class="ui-li-aside"> \
				<strong>-msgTime-</strong></p> \
			<div class="msgStatus -state-"></div> \
		</a></li>';

		for ( var i = 0; arr.length > i; i++) {
			var repValueArr = {};
			repValueArr['-msgType-'] = arr[i].msgType;
			repValueArr['-msgTypeName-'] = getDisplayEnumValue('msgType',arr[i].msgType);
			repValueArr['-friendId-'] = arr[i].friendId;
			repValueArr['-friendName-'] = arr[i].friendName;
			repValueArr['-msgContent-'] = arr[i].msgContent;
			repValueArr['-msgTime-'] = arr[i].createDate;
			repValueArr['-headPicImageId-'] = arr[i].friendHeadPicImageId;//发消息人头像id
			
			if (arr[i].state=="new"){
				repValueArr['-state-'] = "active";
			}else{
				repValueArr['-state-'] = "inactive";
			}
			

			var liHtml = replaceAll(liTemplate, repValueArr);
			ulHtml += liHtml;
		}

		$('#messageListUL').append(ulHtml);
		$('#messageListUL').listview("refresh");
	}
	
	
	function toMsgPage(obj,friendId, friendName, msgType, friendHeadPicImageId) {
		$(obj).children('.msgStatus').removeClass('active').addClass('inactive');
		var params = 'friendId=' + friendId;
		params += '&friendName=';
		params += friendName;
		params += '&friendHeadImageId=';
		params += friendHeadPicImageId;
		params += '&msgType=';
		params += msgType;
		changeSubPage('friendsMsg', 'messagePage', params);
	}

	function loadFriendList() {
		var cachedUserInfo = str2Json(localStorage.userInfo);
		if (cachedUserInfo != null) {
			var userInfo = {};
			userInfo.userId = cachedUserInfo.userId;
			ajaxReq('userAction', {
				method : 'getFriendList',
				userInfo : json2Str(userInfo)
			}, function(data) {
				if (data.length > 0) {
					fillFriendList(data);
				} else {
					$('#friendList .pullNoData').show();
				}
			});
		}
	}
	function fillFriendList(arr) {
		var ulHtml = '';
		var liTemplate = '<li data-icon="false"><a href="#" onclick="toMsgPage(\'-friendId-\',\'-friendName-\',\'friendMsg\',\'-friendHeadPicImageId-\')"><img style="margin:5px;height:70px;width:70px;border-radius:50px;top:10px;" src="-friendHeadPic-"></img> \
			<h3>-friendName-</h3> \
			<p>-friendFeelingText-</p> \
			<p style="float:left;">-friendType--privateFriend-&nbsp;|&nbsp;<i class="fa fa-street-view"></i>-distance-米</p> \
		</a></li>';

		for (var i = 0; arr.length > i; i++) {
			var repValueArr = {};
			repValueArr['-friendId-'] = arr[i].friendId;
			repValueArr['-friendName-'] = arr[i].friendName;
			if (arr[i].feelingText!=null){
				repValueArr['-friendFeelingText-'] = arr[i].feelingText;
			}else{
				repValueArr['-friendFeelingText-'] = '';
			}
			
			repValueArr['-friendHeadPic-'] = createImageUrl(arr[i].friendHeadPicImageId);
			repValueArr['-friendHeadPicImageId-'] = arr[i].friendHeadPicImageId;
			
			var friendType = arr[i].friendType;
			repValueArr['-friendType-'] = getDisplayEnumValue('userType',friendType);
			
			if (friendType=='private'){
				var sex = arr[i].sex==null?'性别未知':arr[i].sex;
				var age = arr[i].age==null?'年龄未知':arr[i].age;
				var privateFriendInfo = '&nbsp;|&nbsp;-sex-&nbsp;|&nbsp;-age-'.replace('-sex-',getDisplayEnumValue('sex',sex)).replace('-age-',age);
				repValueArr['-privateFriend-'] = privateFriendInfo;
			}else{
				repValueArr['-privateFriend-'] = '';
			}
			
			repValueArr['-distance-'] = arr[i].distance;
			
			var liHtml = replaceAll(liTemplate, repValueArr);
			ulHtml += liHtml;
		}

		$('#friendListUL').append(ulHtml);
		$('#friendListUL').listview("refresh");
	}

	//显示加好友方式菜单
	function toAddFriend() {
		var userInfo = getLoginUserInfo();
		if (userInfo == null) {//未登陆过，则显示登陆页面
			return;
		}
		$('#popupMenu').popup('open');
	}
	//使用手机号码增加好友
	function addFriendByCellphone() {
		$('#popupMenu').popup("close");
		changeSubPage('addCellphoneFriend', 'messagePage');
	}
	//查找附近的人并加为好友
	function addFriendByNearby() {
		$('#popupMenu').popup("close");
		changeSubPage('addNearbyFriend', 'messagePage');
	}
</script>
</html>