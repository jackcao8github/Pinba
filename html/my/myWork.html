<!DOCTYPE html>
<html manifest="../pinba.appcache">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width" />
<link rel="stylesheet" href="../css/jquery.mobile-1.4.5.css" />
<script src="../js/jquery-1.11.3.js"></script>
<script src="../js/jquery.mobile-1.4.5.js"></script>
<script src="../myjs/mycommon.js"></script>
<script type="text/javascript" src="../myjs/myswipe.js"></script>
<style>
</style>

<script type="text/javascript">
	$(document).ready(function() {
		getWorkList();
	});
	function swipeRight() {
		closeSubPage();
	}

	function openResumeDetail(obj) {
		var resumeid = $(obj).attr('resumeId');
		changeSubPage('resumeDetail', 'myWorkPage', 'resumeId=' + resumeid);
	}

	function openWork(obj) {
		var workId = $(obj).attr('workId');
		changeSubPage('workDetail', 'myWorkPage', 'workId=' + workId);
	}
	function openReqWorkDetail(obj) {
		var workId = $(obj).attr('workId');
		changeSubPage('reqWorkDetail', 'myWorkPage', 'workId=' + workId);
	}

	function getWorkList() {
		$('#hiredWorkList').html('');
		$('#hiredWorkList').listview("refresh");
		$('#interviewWorkList').html('');
		$('#interviewWorkList').listview("refresh");
		$('#completeWorkList').html('');
		$('#completeWorkList').listview("refresh");
		
		var workInfo = {};
		var cachedUserInfo = getLoginUserInfo();
		if (cachedUserInfo != null) {
			workInfo.staffUserId = cachedUserInfo.userId;//员工用户
			workInfo.userToken = cachedUserInfo.userToken;
			workInfo.page = '1';

			ajaxReq(
					'workAction',
					{
						method : 'getWorkListByStaffId',
						workInfo : json2Str(workInfo)
					},
					function(data) {
						if (data.length >0) {
							var hiredWorkArr = [];
							var interviewWorkArr = [];
							var completedWorkArr = [];
							
							for ( var i = 0; data.length > i; i++) {
								if (data[i].state=='hired'||data[i].state=='checkIn'){//已录用
									hiredWorkArr.push(data[i]);
								}else if (data[i].state=='reserved'){//已预约面试
									interviewWorkArr.push(data[i]);
								}else if (data[i].state=='checkOut'){//已完成
									completedWorkArr.push(data[i]);
								}
							}
							if (hiredWorkArr.length>0){
								fillHiredWorkList(hiredWorkArr);
							}
							
							if (interviewWorkArr.length>0){
								fillInterviewedWorkList(interviewWorkArr);
							}
							
							if (completedWorkArr.length>0){
								fillCompletedWorkList(completedWorkArr);
							}
						} else {
							alert(data.msg);
						}
					});
		}
	}
	/* 签到 ，签退*/
	function check(obj) {
		var workId = $(obj).attr('workId');
		var checkType='';
		if (obj.id=="checkInBtn"){
			checkType='checkIn';
		}else{
			checkType='checkOut';
		}
		var cachedUserInfo = getLoginUserInfo();
		if (cachedUserInfo != null) {
			var workInfo = {};
			workInfo.userId = cachedUserInfo.userId;//员工用户
			workInfo.workId = workId;//工作id
			workInfo.checkType = checkType;
			
			if (checkType=='checkIn'){
				workInfo.checkInPosition = {};
				workInfo.checkInPosition.latitude = localStorage.latitude;
				workInfo.checkInPosition.longitue = localStorage.longitude;
				workInfo.checkInPosition.cityName = localStorage.city;
			}else{
				workInfo.checkOutPosition = {};
				workInfo.checkOutPosition.latitude = localStorage.latitude;
				workInfo.checkOutPosition.longitue = localStorage.longitude;
				workInfo.checkOutPosition.cityName = localStorage.city;
			}
			
			
			ajaxReq('workAction', {
				method : 'checkInOrOut',
				workInfo : json2Str(workInfo)
			}, function(data) {
				if (data.flag == 'success') {//签到成功
					if (checkType=='checkIn'){
						$('#checkInBtn').attr({"disabled":"disabled"});
						$('#checkInBtn').html('签到时间:'+data.checkTime);
					}else{
						$('#checkOutBtn').attr({"disabled":"disabled"});
						$('#checkOutBtn').html('签退时间:'+data.checkTime);
					}
				} else {
					alert(data.msg);
				}
			});
		}
	}
	function fillHiredWorkList(arr) {
		$('#hiredWorkList').html('');//清除已有li
		
		var ulHtml = '<li data-role="list-divider">未完成</li>';
		var liTemplate = '<li data-icon="false"><a onclick="openWork(this)" workId="-workId-" \
			style="padding-top: 0px; padding-bottom: 0px;"> \
				<h2>工作名称:-workName-</h2>\
				<p>工作单位:-userName-</p> \
				<p>工作时间:-workTimeBegin-至-workTimeEnd-</p> \
				<p>工作地点:-workAddress-</p> \
		</a></li>';

		var liTemplate2 = '<li data-icon="false">\
			<fieldset class="ui-grid-a">\
				<div class="ui-block-a">\
					<button \
						class="ui-btn ui-corner-all ui-btn-a ui-mini" workId="-workId-" onclick="check(this)" id="checkInBtn" -disabled->签到-checkInTime-</button>\
				</div><div class="ui-block-b">\
					<button \
						class="ui-btn ui-corner-all ui-btn-a ui-mini"  workId="-workId-" onclick="check(this)" id="checkOutBtn">签退</button>\
				</div></fieldset></li>';

		for ( var i = 0; arr.length > i; i++) {
			var repValueArr = {};
			repValueArr['-workId-'] = arr[i].workId;
			repValueArr['-workName-'] = arr[i].workName;
			repValueArr['-userName-'] = arr[i].userName;
			repValueArr['-workTimeBegin-'] = arr[i].workTimeBegin;
			repValueArr['-workTimeEnd-'] = arr[i].workTimeEnd;
			repValueArr['-workAddress-'] = arr[i].workAddress;
			if (arr[i].state=="checkIn"){//如果是已签到则显示签到时间并将签到按钮置灰
				repValueArr['-disabled-'] = 'disabled';
				repValueArr['-checkInTime-'] = '时间:'+arr[i].checkInTime;
			}else{
				repValueArr['-disabled-'] = '';
				repValueArr['-checkInTime-'] = '';
			}
			
			var liHtml = replaceAll(liTemplate, repValueArr);
			ulHtml += liHtml;

			var liHtml2 = replaceAll(liTemplate2, repValueArr);
			ulHtml += liHtml2;
			
			
		}
		
		$('#hiredWorkList').append(ulHtml);
		$('#hiredWorkList').listview("refresh");
	}

	function fillInterviewedWorkList(arr) {
		var ulHtml = '<li data-role="list-divider">预约面试</li>';
		var liTemplate = '<li data-icon="false"><a onclick="openWork(this)" workId="-workId-" \
			style="padding-top: 0px; padding-bottom: 0px;"> \
				<h2>工作名称:-workName-</h2>\
				<p>工作单位:-userName-</p> \
				<p>面试时间:-interviewTime-</p> \
				<p>面试地点:-interviewAddress-</p> \
		</a></li>';

		for ( var i = 0; arr.length > i; i++) {
			var repValueArr = {};
			repValueArr['-workId-'] = arr[i].workId;
			repValueArr['-workName-'] = arr[i].workName;
			repValueArr['-userName-'] = arr[i].userName;
			repValueArr['-interviewTime-'] = arr[i].interviewTime;
			repValueArr['-interviewAddress-'] = arr[i].interviewAddress;

			var liHtml = replaceAll(liTemplate, repValueArr);
			ulHtml += liHtml;
		}
		$('#interviewWorkList').html('');
		$('#interviewWorkList').append(ulHtml);
		$('#interviewWorkList').listview("refresh");
	}
	function fillCompletedWorkList(arr) {
		var ulHtml = '<li data-role="list-divider">已完成</li>';
		var liTemplate = '<li data-icon="false"><a onclick="openWork(this)" workId="-workId-" \
			style="padding-top: 0px; padding-bottom: 0px;"> \
				<h2>工作名称:-workName-</h2>\
				<p>工作单位:-userName-</p> \
				<p>签到时间:-checkInTime-</p> \
				<p>签退时间:-checkOutTime-</p> \
		</a></li>';

		for ( var i = 0; arr.length > i; i++) {
			var repValueArr = {};
			repValueArr['-workId-'] = arr[i].workId;
			repValueArr['-workName-'] = arr[i].workName;
			repValueArr['-userName-'] = arr[i].userName;
			repValueArr['-checkInTime-'] = arr[i].checkInTime;
			repValueArr['-checkOutTime-'] = arr[i].checkOutTime;

			var liHtml = replaceAll(liTemplate, repValueArr);
			ulHtml += liHtml;
		}
		$('#completeWorkList').html('');
		$('#completeWorkList').append(ulHtml);
		$('#completeWorkList').listview("refresh");
	}
	function getResumeList() {
		$('#resumeListUL').html('');
		var resumeInfo = {};
		var cachedUserInfo = getLoginUserInfo();
		if (cachedUserInfo != null) {
			resumeInfo.userId = cachedUserInfo.userId;
			resumeInfo.userToken = cachedUserInfo.userToken;
			resumeInfo.page = '1';

			ajaxReq(
					'resumeAction',
					{
						method : 'getResumeList',
						resumeInfo : json2Str(resumeInfo)
					},
					function(data) {
						if (data.flag != 'fail') {
							var lihtmls = '';
							for ( var i = 0; data.length > i; i++) {
								var resumeobj = data[i];
								var lihtml = '<li><a onclick="openResumeDetail(this)" resumeId="'
										+ resumeobj.resumeId
										+ '"><h3>简历名称:'
										+ resumeobj.resumeName
										+ '</h3><p>简历类型:'
										+ resumeobj.resumeType
										+ '</p><p>简历投递次数:'
										+ resumeobj.resumeSendNumber
										+ '&nbsp;|&nbsp;简历查看次数:'
										+ resumeobj.lookNumber
										+ '</p></a></li>';
								lihtmls += lihtml;
							}
							$('#resumeListUL').append(lihtmls);
							$('#resumeListUL').listview("refresh");
						} else {
							alert(data.msg);
						}
					});
		}
	}

	function getReqWorkList() {
		$('#reqWorkListUL').html('');
		var workInfo = {};
		var cachedUserInfo = getLoginUserInfo();
		if (cachedUserInfo != null) {
			workInfo.userId = cachedUserInfo.userId;
			workInfo.userToken = cachedUserInfo.userToken;
			workInfo.page = '1';
			workInfo.workType = 'reqPartTime,reqFullTime';//兼职/全职类求职

			ajaxReq(
					'workAction',
					{
						method : 'getWorkList',
						workInfo : json2Str(workInfo)
					},
					function(data) {
						if (data.flag != 'fail') {
							var lihtmls = '';
							var litemplate = '<li><a onclick="openReqWorkDetail(this)" workId="+workId+"><h3>+workName+</h3><p>+workType+</p><p>发布时间:+effDate+&nbsp;|&nbsp;失效时间:+expDate+</p><p>关注数:+focusNumber+&nbsp;|&nbsp;查看数:+lookNumber+</p></a></li>';
							for ( var i = 0; data.length > i; i++) {
								var workObj = data[i];
								var lihtml = litemplate.replace('+workId+',
										workObj.workId).replace('+workName+',
										workObj.workName).replace(
										'+workType+',
										getDisplayEnumValue('workType',
												workObj.workType)).replace(
										'+effDate+', workObj.effDate).replace(
										'+expDate+', workObj.expDate).replace(
										'+focusNumber+', workObj.focusNumber)
										.replace('+lookNumber+',
												workObj.lookNumber);
								lihtmls += lihtml;
							}
							$('#reqWorkListUL').append(lihtmls);
							$('#reqWorkListUL').listview("refresh");
						} else {
							alert(data.msg);
						}
					});
		}
	}
</script>
</head>
<body>
	<div data-role="page" id="myWorkPage">
		<div data-role="header" data-position="fixed" data-fullscreen="false">
			<!-- 返回按钮 -->
			<a href="#" data-rel="back"
				class="ui-btn ui-btn-left ui-alt-icon ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-carat-l"
				onclick="closeSubPage();return false;">Back</a>

			<h1>我的工作</h1>
		</div>

		<div id="tabs" data-role="tabs">
			<div data-role="navbar">
				<ul>
					<li><a href="#wrokList" class="ui-btn-active"
						onclick="getWorkList()">工作记录</a></li>
					<li><a href="#resumeList" id="messageTabLi"
						onclick="getResumeList()">简历</a></li>
					<li><a href="#reqworkList" onclick="getReqWorkList()">求职记录</a></li>
				</ul>
			</div>

			<div id="resumeList">
				<ul data-role="listview" id="resumeListUL">

				</ul>
				<a data-role="button" data-mini="true" data-icon="plus"
					onclick="changeSubPage('resume', 'myWorkPage')">增加一个简历</a>
			</div>

			<div data-role="popup" id="delResume" data-theme="a"
				data-overlay-theme="b" class="ui-content"
				style="max-width: 340px; padding-bottom: 2em;">
				    
				<h3>删除这个简历?</h3>
				<p>确定要删除这个简历吗?</p>
				    <a onclick="delResume()" data-rel="back"
					class="ui-shadow ui-btn ui-corner-all ui-btn-b ui-icon-check ui-btn-icon-left ui-btn-inline ui-mini">确定</a>
				<a data-rel="back"
					class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-mini">取消</a>
			</div>

			<div id="wrokList">
				<ul data-role="listview" id="hiredWorkList">
				</ul>
				<ul data-role="listview" id="interviewWorkList">
				</ul>
				<ul data-role="listview" id="completeWorkList">
				</ul>
			</div>
			<div id="reqworkList">
				<ul data-role="listview" id="reqWorkListUL">
				</ul>
				<a data-role="button" data-mini="true" data-icon="plus"
					onclick="changeSubPage('reqwork', 'myWorkPage')">发布求职信息</a>
			</div>
		</div>

	</div>
</body>
</html>