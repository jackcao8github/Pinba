<!DOCTYPE html>
<html manifest="../pinba.appcache">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width" />

<link rel="stylesheet" href="../css/jquery.mobile-1.4.5.css" />
<link rel="stylesheet" href="../mycss/mygrid.css" />
<link rel="stylesheet" href="../css/font-awesome.css" />
<script src="../js/jquery-1.11.3.js"></script>
<script src="../js/jquery.mobile-1.4.5.js"></script>
<script src="../myjs/mycommon.js"></script>
<script type="text/javascript" src="../myjs/myswipe.js"></script>

<script type="text/javascript">
	$(document).ready(function() {
		pageInit();
		//图片选择控件的响应方法
		document.getElementById('imgFile').onchange = function(evt) {  
		    // 如果浏览器不支持FileReader，则不处理  
		    if (!window.FileReader) return;  
		    var files = evt.target.files;  
		    for (var i = 0, f; f = files[i]; i++) {  
		        if (!f.type.match('image.*')) {  
		        	alert('必须是图片文件!');
			          return false;
		        }
		     	// 做一下诸如文件大小校验的动作
		        if(f.size > 1024 * 1024 * 5) {
		          alert('图片大小不能超过 5MB!');
		          return false;
		        }
		        console.log(f);
		        var reader = new FileReader();  
		        reader.onload = (function(theFile) {  
		            return function(e) {  
		                // 显示图片到img 元素  
		                document.getElementById('image').src = e.target.result;
		                //将图片上传到服务器
		                var userInfo = {};
						var cachedUserInfo = getLoginUserInfo();
						if (cachedUserInfo != null) {
							userInfo.userId = cachedUserInfo.userId;
							userInfo.userToken = cachedUserInfo.userToken;
							userInfo.userHeadPicData = e.target.result;
				
							ajaxReq(
									'userAction',
									{
										method : 'saveHeadPic',
										userInfo : json2Str(userInfo)
									},
									function(data) {
										alert(data);
									});
						 }  
		        }})(f);  
		  
		        reader.readAsDataURL(f);  
		    }  
		}  
	});
	var userId = 0;
	function pageInit() {
		var cachedUserInfo = getLoginUserInfo();
		if (cachedUserInfo != null) {
			var userInfo = {};
			userId = cachedUserInfo.userId;
			userInfo.userId = cachedUserInfo.userId;
			ajaxReq('userAction', {
				method : 'getUserInfo',
				userInfo : json2Str(userInfo)
			}, function(data) {
				if (data.flag == 'success') {//登陆成功后返回主页面
					bindData(data, 'userInfoDiv');
				} else {
					alert(data.msg);
					return false;
				}
			});
		}
	}
	//绑定数据到控件
	function bindData(jsonData, divId) {
		for ( var o in jsonData) {
			var ctrl = $('#' + divId + ' #' + o);
			if (ctrl.length > 0) {
				//处理下拉框采集的数据
				var realValue = jsonData[o];
				var displayValue = getDisplayEnumValue(o, realValue);
				ctrl.html(displayValue);
			}
		}
	}

	function modUserInfo() {
		changeSubPage('changePrivateUserInfo', 'userInfoPage', 'userId='
				+ userId);
	}
	function logout() {
		localStorage.removeItem("userInfo");

		closeSubPage();
	}

	function swipeRight() {
		closeSubPage();
	}
	
	function changeHeadPic(){
		$('#popupMenu').popup();
		$('#popupMenu').popup('open');
	}
	
	function selectFromFile(){
		$('#imgFile').click();
		$('#popupMenu').popup('close');
	}
	
	function selectFromCamera(){
		$('#popupMenu').popup('close');
	}
</script>
</head>
<body>
	<div data-role="page" id="userInfoPage">

		<div data-role="header">
			<a href="#" data-rel="back"
				class="ui-btn ui-btn-left ui-alt-icon ui-nodisc-icon ui-corner-all ui-btn-icon-notext ui-icon-carat-l"
				onclick="closeSubPage();return false;">Back</a>
			<h1>用户信息</h1>
			<a onclick="modUserInfo()" id="modBtn"
				class="ui-btn ui-corner-all ui-shadow ui-btn-icon-left ui-icon-edit">修改用户信息</a>
		</div>
		<div class="login">
			<img src="http://image.zhangxinxu.com/image/study/s/s128/mm5.jpg"
				id="image" alt="" class="personal_logo" onclick="changeHeadPic()">
			<div class="userinfo">
				<div class="title" id="userName">点击图片设置头像</div>
			</div>
		</div>
		<!-- 简历选择框 -->
		<div data-role="popup" id="popupMenu">
			<ul data-role="listview" data-inset="true" style="min-width: 210px;"
				id="selectHeadPicSrc">
				<li><a href="#" onclick="selectFromFile()">从相册选择</a></li>
				<li><a href="#" onclick="selectFromCamera()">使用相机拍摄</a></li>
			</ul>
		</div>

		<input type="file" id="imgFile" style="display: none;"
			accept="image/*" />

		<!-- 第一块 -->
		<div class="firstblock">
			<ul data-role="listview" data-mini="true" id="userInfoDiv">
				<li data-icon="false"><a href="#">昵称 <span
						class="ui-li-count" id="userName"></span></a></li>
				<li data-icon="false"><a href="#">性别 <span
						class="ui-li-count" id="sex"></span></a></li>
				<li data-icon="false"><a href="#">年龄 <span
						class="ui-li-count" id="age"></span></a></li>
				<li data-icon="false"><a href="#">手机 <span
						class="ui-li-count" id="cellphone"></span></a></li>
				<li data-icon="false"><a href="#">邮箱 <span
						class="ui-li-count" id="email"></span></a></li>
			</ul>

			<div class="h1"></div>
			<a data-role="button" style="background: red" onclick="logout()">退出当前帐户</a>
		</div>

	</div>
</body>
</html>